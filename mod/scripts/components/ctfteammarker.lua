---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by darionco.
--- DateTime: 2021-03-02 7:56 p.m.
---
local require = _G.require;
local CTF_TEAM_CONSTANTS = require('constants/CTFTeamConstants');

local function getTeamColor(id)
    return unpack(CTF_TEAM_CONSTANTS.TEAM_COLORS[math.min(id, 5)]);
end

local CTFTeamMarker = Class(function(self, inst)
    self.inst = inst;
    self.marker = inst:SpawnChild('ctf_team_marker');

    self.net_health_percent = _G.net_float(inst.GUID, 'ctf_net_health_percent', 'ctf_net_health_percent');
    if not TheNet:IsDedicated() then
        self:InitHealthBar();
        inst:ListenForEvent('ctf_net_health_percent', function()
            local percent = self.net_health_percent:value();
            self:SetHealthPercent(percent);
        end);
    end

    if inst.components and inst.components.health then
        inst:ListenForEvent('healthdelta', function(owner, data)
            if not inst.components.health:IsDead() and not inst:HasTag('playerghost') then
                self.net_health_percent:set(data.newpercent);
            else
                self.net_health_percent:set(0);
            end
        end);
    end
end);

function CTFTeamMarker:SetTeam(teamID)
    --self.marker.Label:SetText('[T' .. teamID .. ']');
    --self.marker.Label:SetColour(getTeamColor(teamID));
    self.marker.AnimState:SetMultColour(getTeamColor(teamID));
end

function CTFTeamMarker:SetHealthPercent(percent)
    self.marker.AnimState:SetTime(3.61 * (1 - percent));
end

function CTFTeamMarker:InitHealthBar()
    self.marker.AnimState:PlayAnimation("health");
    self.marker.AnimState:SetDeltaTimeMultiplier(0);
    self.marker.AnimState:SetTime(0);

    --local InstTransform = _G.getmetatable(self.inst.Transform).__index;
    --local OldSetRotation = InstTransform.SetRotation;
    --InstTransform.SetRotation = function(f_self, rot)
    --    if f_self == self.dinst.Transform then
    --        self.marker.Transform:SetRotation(-rot);
    --    end
    --    OldSetRotation(f_self, rot);
    --end
    self.inst:StartUpdatingComponent(self);
end

function CTFTeamMarker:OnUpdate()
    self.marker.Transform:SetRotation(-self.inst.Transform:GetRotation());
end

return CTFTeamMarker;
