---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by darionco.
--- DateTime: 2021-03-02 6:38 p.m.
---
local require = _G.require;
local CTF_TEAM_CONSTANTS = require('constants/CTFTeamConstants');

local assets = {
    Asset('ANIM', 'anim/ctf_team_marker.zip'),
};

local function createMarker(inst)
    local marker = SpawnPrefab('ctf_team_marker');
    marker.entity:AddFollower();
    marker.Follower:FollowSymbol(inst.GUID, 'assets', 0, 0, 0);

    marker.AnimState:PlayAnimation('health');
    marker.AnimState:SetDeltaTimeMultiplier(0);
    marker.AnimState:SetTime(0);
    marker.AnimState:SetScale(-1, 1);

    return marker;
end

local function applyTeamColor(inst, teamID)
    if teamID ~= 0 then
        inst.AnimState:SetMultColour(unpack(CTF_TEAM_CONSTANTS.TEAM_COLORS[math.min(teamID, 5)]));
    end
end

local function applyHealthPercent(inst, percent)
    inst.AnimState:SetTime(3.61 * (1 - percent));
end

local function listenForDataChanges(inst)
    if not TheNet:IsDedicated() then
        inst.marker = createMarker(inst);

        if inst.marker then
            applyHealthPercent(inst.marker, inst.ctf_health:value());
            inst:ListenForEvent('ctf_health', function()
                applyHealthPercent(inst.marker, inst.ctf_health:value());
            end);

            applyTeamColor(inst.marker, inst.ctf_team_id:value());
            inst:ListenForEvent('ctf_team_id', function()
                applyTeamColor(inst.marker, inst.ctf_team_id:value());
            end);
        end
    end
end

local function monitorOwnerHealth(inst, owner)
    if TheWorld.ismastersim and owner.components and owner.components.health then
        owner:ListenForEvent('healthdelta', function(_, data)
            if owner:HasTag('playerghost') then
                inst.ctf_health:set(0);
            else
                inst.ctf_health:set(data.newpercent);
            end
        end);
    end
end

local function ctf()
    local inst = CreateEntity();

    inst.entity:AddTransform();
    inst.entity:AddAnimState();
    inst.entity:AddNetwork();

    inst:AddTag('FX');
    inst:AddTag('NOCLICK');

    inst.AnimState:SetBank('ctf_team_marker');
    inst.AnimState:SetBuild('ctf_team_marker');
    inst.AnimState:PlayAnimation('idle');
    inst.AnimState:SetOrientation(ANIM_ORIENTATION.OnGroundFixed);
    inst.AnimState:SetLayer(LAYER_WORLD_BACKGROUND);
    inst.AnimState:SetSortOrder(3);

    inst.ctf_health = net_float(inst.GUID, 'ctf_health', 'ctf_health');
    inst.ctf_health:set(1);

    inst.ctf_team_id = net_tinybyte(inst.GUID, 'ctf_team_id', 'ctf_team_id');
    inst.ctf_team_id:set(0);

    inst:DoTaskInTime(0, function()
        local owner = inst.entity:GetParent();
        if owner then
            --inst.Transform:SetPosition(0, -0.05, 0);
            inst.entity:Hide();

            listenForDataChanges(inst);
            monitorOwnerHealth(inst, owner);
        end
    end);

    inst.entity:SetPristine();

    return inst;
end

return Prefab('ctf_team_marker', ctf, assets);
