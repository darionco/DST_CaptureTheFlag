---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by darionco.
--- DateTime: 2021-02-21 1:38 p.m.
---

local require = GLOBAL.require;
local CTF_TEAM_CONSTANTS = require('constants/CTFTeamConstants');
local PlayerStatusScreen = require('screens/playerstatusscreen');
local CTFPlayerStats = require('widgets/CTFPlayerStats');

local OldGetDisplayName = PlayerStatusScreen.GetDisplayName;
PlayerStatusScreen.GetDisplayName = function(self, clientrecord)
    local result = OldGetDisplayName(self, clientrecord);
    local player = CTFTeamManager:getCTFPlayer(clientrecord.userid);
    local teamID = player and player:getTeamID() or 0;
    if teamID ~= 0 and clientrecord.netid ~= nil then
        -- patch the client color here
        clientrecord.colour = CTF_TEAM_CONSTANTS.TEAM_COLORS[teamID];
        return '[T' .. teamID .. '] ' .. result;
    end

    return result;
end

local function no_op()end;
local function patchWidgetFunction(widget, fnName)
    widget['_' .. fnName] = widget[fnName];
    widget[fnName] = no_op;
end

local function patchListingLayout(listing)
    patchWidgetFunction(listing.viewprofile, 'SetPosition');
    listing.viewprofile:_SetPosition(232,-6,0);
    listing.viewprofile:SetNormalScale(0.21);
    listing.viewprofile:SetFocusScale(0.21*1.1);

    patchWidgetFunction(listing.mute, 'SetPosition');
    listing.mute:_SetPosition(232,16,0);
    listing.mute:SetNormalScale(0.21);
    listing.mute:SetFocusScale(0.21*1.1);

    patchWidgetFunction(listing.kick, 'SetPosition');
    listing.kick:_SetPosition(365,-8,0);
    listing.kick:SetNormalScale(0.25);
    listing.kick:SetFocusScale(0.25*1.1);

    patchWidgetFunction(listing.ban, 'SetPosition');
    listing.ban:_SetPosition(365,18,0);
    listing.ban:SetNormalScale(0.25);
    listing.ban:SetFocusScale(0.25*1.1);

    patchWidgetFunction(listing.useractions, 'SetPosition');
    listing.useractions:_SetPosition(392,-8,0);
    listing.useractions:SetNormalScale(0.25);
    listing.useractions:SetFocusScale(0.25*1.1);

    patchWidgetFunction(listing.age, 'SetString');
    patchWidgetFunction(listing.age, 'Show');
    patchWidgetFunction(listing.age, 'Hide');
    listing.age:_SetString('');
    listing.age:_Hide();

    listing.stats = listing:AddChild(CTFPlayerStats());
    listing.stats:SetPosition(-55, 0, 0);
end

AddClassPostConstruct('widgets/scrollablelist', function(self, items, _, _, _, _, updatefn, widgetstoupdate, _, _, _, _, _, _, _)
    local info = debug.getinfo(4, 'f');
    if info and info.func == PlayerStatusScreen.DoInit then
        self.updatefn = function(playerListing, client, i)
            updatefn(playerListing, client, i);
            if playerListing.stats then
                local this_user_is_dedicated_server = client.performance ~= nil and not TheNet:GetServerIsClientHosted();
                if not this_user_is_dedicated_server then
                    playerListing.stats:setUser(client.userid);
                else
                    playerListing.stats:setUser(nil);
                end
            end
        end

        for _, v in ipairs(widgetstoupdate) do
            patchListingLayout(v);
            if v.userid and v.viewprofile:IsVisible() then
                v.stats:setUser(v.userid);
            end
        end
    end
end);
